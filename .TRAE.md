# Context Bridge 项目进度报告

## 1. 项目概况 (Project Overview)
**Context Bridge** 是一个旨在连接碎片化信息采集与 LLM 上下文构建的浏览器插件。它允许用户从网页高效采集信息（Web Clipper），并在侧边栏进行清洗、重组（Context Assembler），最终生成可供大模型使用的结构化 Context。

- **核心价值**: 采集 (Capture) -> 暂存 (Staging) -> 合成 (Synthesis) -> 归档 (Archive)
- **技术栈**: Chrome Manifest V3, React, TypeScript, TailwindCSS, Zustand, Turndown, Readability, dnd-kit.

## 2. 当前进度 (Current Status)
**当前阶段**: Phase 2 (交互与流转) 已完成，Phase 3 (AI 增强) 初期。

项目骨架已搭建完毕，核心的“采集-暂存-合成-归档”闭环工作流已打通。用户可以进行网页划选采集、整页采集，并在侧边栏对条目进行拖拽排序、模板化合成以及归档管理。

### 2.1 已完成功能 (Completed Features)

#### 🏗️ 基础架构
- [x] **Manifest V3 环境**: 包含 Background Service Worker, Content Scripts, Side Panel, Popup, Options 页面的完整构建配置。
- [x] **UI 框架**: 基于 React + TailwindCSS 的响应式侧边栏布局。
- [x] **数据存储**: 封装 `chrome.storage.local` 实现数据持久化。

#### ✂️ 采集模块 (Capture Engine)
- [x] **智能浮动按钮**: 鼠标划选文本后自动弹出 "Save" 按钮（Shadow DOM 实现，样式隔离）。
- [x] **HTML 转 Markdown**: 集成 `turndown` 库，自动清洗采集到的富文本。
- [x] **整页采集**: 集成 `@mozilla/readability`，支持通过右键菜单采集网页正文。
- [x] **交互优化**: 解决了 Shadow Host 层级遮挡和事件冒泡冲突问题。

#### 📋 侧边栏工作台 (Side Panel Workbench)
- [x] **三段式布局**: Staging Area (暂存), Synthesis Zone (合成), Archive Area (归档)。
- [x] **暂存区 (Staging Area)**:
    - 支持条目展示、删除、一键复制。
    - **拖拽排序**: 集成 `dnd-kit` 实现条目自由排序。
    - **多选操作**: 支持批量选中条目进行删除或归档。
- [x] **合成区 (Synthesis Zone)**:
    - **模板系统**: 支持选择不同模板（默认/自定义）进行文本拼接。
    - **预览编辑**: 合成结果实时预览。
    - **流转闭环**: 实现了“确认合成”逻辑，自动将合成结果存为新条目，并归档原始素材（原子操作，解决了竞态问题）。
- [x] **归档区 (Archive Area)**:
    - 历史条目展示。
    - **一键还原**: 支持将归档条目恢复至暂存区。
    - 动画效果 (`framer-motion`)。

#### ⚙️ 设置与控制
- [x] **全局开关**: 监听 `extensionEnabled` 状态控制采集功能启停。
- [x] **模板管理**: 在 Options 页面支持自定义合成模板。

---

## 3. 待办事项 (Roadmap & Next Steps)

### Phase 3: AI 增强 (当前重点)
- [ ] **特定站点适配**: 针对 ChatGPT / Claude / Gemini 等 AI 对话页面，开发专用的 DOM 解析器，注入“Add to Context”按钮。
- [ ] **真·AI 合成**: 目前合成仅为模板字符串拼接。下一步需接入 OpenAI/Anthropic API，实现真正的“去重总结”、“对话还原”等智能合成功能。
- [ ] **Token 估算**: 集成 `gpt-tokenizer` 或近似算法，在侧边栏实时显示 Token 计数。

### Phase 4: 细节打磨与发布
- [ ] **来源回溯**: 实现点击来源链接时，利用 `Scroll to Text Fragment` 技术跳转并高亮原始网页中的文字。
- [ ] **去噪优化**: 增强 Markdown 清洗规则，自动移除广告和无关元素。
- [ ] **测试覆盖**: 补充关键工具函数的单元测试和 E2E 测试。

## 4. 目录结构说明 (Directory Structure)

```
context-bridge-extension/
├── src/
│   ├── background/          # Service Worker (ContextMenu, Messaging)
│   ├── content/             # Content Scripts
│   │   ├── components/      # 注入页面的 UI (CaptureOverlay)
│   │   ├── utils/           # 解析工具 (parsePage - Readability)
│   │   └── index.tsx        # 入口
│   ├── sidepanel/           # 侧边栏主应用
│   │   ├── components/      # StagingArea, SynthesisZone, ArchiveArea
│   │   ├── hooks/           # useClips (核心状态逻辑)
│   │   └── App.tsx          # 侧边栏入口
│   ├── options/             # 设置页面 (模板编辑)
│   ├── popup/               # 弹出面板
│   └── types/               # TS 类型定义
├── docs/                    # 原始设计文档
└── .trae/                   # Trae  IDE 配置文件
```

## 5. 常用命令
- `npm run dev`: 开发模式。
- `npm run build`: 构建生产版本。
